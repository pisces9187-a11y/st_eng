<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Flashcard Study - English Learning Platform</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/flashcard-audio-player.css">
    
    <style>
        /* Flashcard 3D Flip Animation */
        .flashcard-container {
            width: 100%;
            max-width: 600px;
            height: 400px;
            perspective: 1000px;
            margin: 2rem auto;
        }
        
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        
        .flashcard-inner.flipped {
            transform: rotateY(180deg);
        }
        
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        .word-text {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .word-ipa {
            font-size: 1.5rem;
            opacity: 0.9;
            font-style: italic;
            margin-bottom: 1rem;
        }
        
        .word-meaning {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .word-example {
            font-size: 1.1rem;
            opacity: 0.95;
            text-align: center;
            font-style: italic;
            margin-top: 1rem;
        }
        
        /* Quality Rating Buttons */
        .rating-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .btn-rating {
            flex: 1;
            min-width: 100px;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-rating:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn-rating-again {
            background: #ff4444;
            color: white;
        }
        
        .btn-rating-hard {
            background: #ffbb33;
            color: white;
        }
        
        .btn-rating-good {
            background: #00C851;
            color: white;
        }
        
        .btn-rating-easy {
            background: #33b5e5;
            color: white;
        }
        
        .rating-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Session Stats */
        .session-stats {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #666;
            font-weight: 600;
        }
        
        /* Progress Bar */
        .progress-container {
            margin: 1rem 0 2rem;
        }
        
        .progress {
            height: 30px;
            border-radius: 15px;
            background: #e9ecef;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Streak Display */
        .streak-display {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            margin-bottom: 1rem;
        }
        
        .streak-icon {
            font-size: 1.5rem;
            animation: flicker 1.5s infinite;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .streak-text {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .flashcard-container {
                height: 350px;
            }
            
            .word-text {
                font-size: 2.5rem;
            }
            
            .word-meaning {
                font-size: 1.5rem;
            }
            
            .rating-buttons {
                flex-direction: column;
            }
            
            .btn-rating {
                min-width: auto;
                width: 100%;
            }
        }
        
        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }
        
        /* Session Complete */
        .session-complete {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .complete-icon {
            font-size: 5rem;
            color: #00C851;
            margin-bottom: 1rem;
        }
        
        .complete-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .complete-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/dashboard.html">
                <i class="fas fa-graduation-cap text-primary"></i>
                English Master
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="streak-display">
                    <i class="fas fa-fire streak-icon"></i>
                    <span class="streak-text" id="streakCount">0 day streak</span>
                </div>
                <a href="/dashboard.html" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Session Header -->
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold mb-3">
                <i class="fas fa-cards-blank me-2 text-primary"></i>
                Flashcard Study Session
            </h1>
            
            <!-- Daily Progress -->
            <div class="row justify-content-center mb-3">
                <div class="col-md-6">
                    <div class="progress-container">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">
                                <i class="fas fa-target"></i>
                                Daily Goal
                            </span>
                            <span class="fw-bold" id="dailyProgressText">0/20 cards</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="dailyProgressBar" role="progressbar" style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Stats -->
            <div class="session-stats" id="sessionStats">
                <div class="stat-card">
                    <div class="stat-value" id="statReviewed">0</div>
                    <div class="stat-label">Reviewed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCorrect">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAccuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRemaining">20</div>
                    <div class="stat-label">Remaining</div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingContainer" class="loading-container">
            <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted fs-5">Loading flashcards...</p>
        </div>

        <!-- Flashcard Container -->
        <div id="flashcardContainer" style="display: none;">
            <!-- Audio Player -->
            <div id="audioPlayerContainer"></div>

            <!-- Flashcard -->
            <div class="flashcard-container" id="flashcard">
                <div class="flashcard-inner" id="flashcardInner">
                    <!-- Front Side -->
                    <div class="flashcard-face flashcard-front">
                        <div class="word-text" id="wordText">Loading...</div>
                        <div class="word-ipa" id="wordIpa"></div>
                        <p class="text-center mt-3 opacity-75">
                            <i class="fas fa-hand-pointer"></i>
                            Click to flip or press Space
                        </p>
                    </div>
                    
                    <!-- Back Side -->
                    <div class="flashcard-face flashcard-back">
                        <div class="word-meaning" id="wordMeaning">Meaning</div>
                        <div class="word-example" id="wordExample"></div>
                        <p class="text-center mt-3 opacity-75">
                            <i class="fas fa-hand-pointer"></i>
                            Click to flip back
                        </p>
                    </div>
                </div>
            </div>

            <!-- Rating Buttons -->
            <div class="rating-buttons" id="ratingButtons" style="display: none;">
                <button class="btn-rating btn-rating-again" onclick="rateCard(0)">
                    <span>ðŸ˜ž</span>
                    <span>Again</span>
                    <span class="rating-label">&lt;1 day</span>
                    <span class="text-white-50 small">[1]</span>
                </button>
                <button class="btn-rating btn-rating-hard" onclick="rateCard(3)">
                    <span>ðŸ¤”</span>
                    <span>Hard</span>
                    <span class="rating-label">3 days</span>
                    <span class="text-white-50 small">[2]</span>
                </button>
                <button class="btn-rating btn-rating-good" onclick="rateCard(4)">
                    <span>ðŸ˜Š</span>
                    <span>Good</span>
                    <span class="rating-label">7 days</span>
                    <span class="text-white-50 small">[3]</span>
                </button>
                <button class="btn-rating btn-rating-easy" onclick="rateCard(5)">
                    <span>ðŸ˜Ž</span>
                    <span>Easy</span>
                    <span class="rating-label">14 days</span>
                    <span class="text-white-50 small">[4]</span>
                </button>
            </div>

            <!-- Help Text -->
            <div class="text-center mt-3">
                <p class="text-muted">
                    <i class="fas fa-keyboard"></i>
                    Keyboard: <strong>Space</strong> to flip, 
                    <strong>A</strong> to play audio, 
                    <strong>1-4</strong> to rate
                </p>
            </div>
        </div>

        <!-- Session Complete -->
        <div id="sessionComplete" style="display: none;">
            <div class="session-complete">
                <div class="complete-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h2 class="complete-title">Session Complete!</h2>
                <p class="complete-subtitle">Great work! You've reviewed all cards.</p>
                
                <!-- Final Stats -->
                <div class="session-stats mb-4">
                    <div class="stat-card">
                        <div class="stat-value" id="finalReviewed">0</div>
                        <div class="stat-label">Cards Reviewed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="finalAccuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="finalTime">0m</div>
                        <div class="stat-label">Time Spent</div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <button class="btn btn-primary btn-lg" onclick="startNewSession()">
                        <i class="fas fa-redo"></i>
                        Study Again
                    </button>
                    <a href="/dashboard.html" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-home"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App Scripts -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/django-api.js"></script>
    <script src="/assets/js/flashcard-audio-player.js"></script>
    <script src="/assets/js/flashcard-study-session.js"></script>
    
    <script>
        // Initialize
        let audioPlayer = null;
        let currentCard = null;
        let isFlipped = false;

        // DOM Elements
        const loadingContainer = document.getElementById('loadingContainer');
        const flashcardContainer = document.getElementById('flashcardContainer');
        const sessionComplete = document.getElementById('sessionComplete');
        const flashcardInner = document.getElementById('flashcardInner');
        const ratingButtons = document.getElementById('ratingButtons');

        // Start session on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize audio player
            audioPlayer = Object.create(FlashcardAudioPlayer);
            audioPlayer.init('#audioPlayerContainer');

            // Start session
            startNewSession();

            // Setup keyboard shortcuts
            setupKeyboardShortcuts();

            // Setup touch gestures
            setupTouchGestures();
        });

        async function startNewSession() {
            loadingContainer.style.display = 'flex';
            flashcardContainer.style.display = 'none';
            sessionComplete.style.display = 'none';

            // Start session (20 cards by default)
            const result = await FlashcardStudySession.startSession(null, 20);

            if (result.success) {
                updateSessionUI();
                loadCurrentCard();
                loadingContainer.style.display = 'none';
                flashcardContainer.style.display = 'block';
            } else {
                alert('Failed to start session: ' + result.error);
            }
        }

        function loadCurrentCard() {
            currentCard = FlashcardStudySession.getCurrentCard();
            
            if (!currentCard) {
                showSessionComplete();
                return;
            }

            // Reset flip state
            isFlipped = false;
            flashcardInner.classList.remove('flipped');
            ratingButtons.style.display = 'none';

            // Update card content
            document.getElementById('wordText').textContent = currentCard.word.text;
            document.getElementById('wordIpa').textContent = currentCard.word.ipa ? `/${currentCard.word.ipa}/` : '';
            document.getElementById('wordMeaning').textContent = currentCard.word.meaning_vi || '';
            document.getElementById('wordExample').textContent = currentCard.word.example_en ? `"${currentCard.word.example_en}"` : '';

            // Load audio
            if (currentCard.word.text && audioPlayer) {
                audioPlayer.loadWord(currentCard.word.text);
            }

            // Update stats
            updateStatsUI();
        }

        function flipCard() {
            isFlipped = !isFlipped;
            flashcardInner.classList.toggle('flipped');
            
            if (isFlipped) {
                ratingButtons.style.display = 'flex';
            }
        }

        async function rateCard(quality) {
            if (!isFlipped) {
                alert('Please flip the card first!');
                return;
            }

            const result = await FlashcardStudySession.reviewCard(quality);

            if (result.success) {
                // Move to next card
                FlashcardStudySession.nextCard();
                
                if (FlashcardStudySession.isComplete()) {
                    showSessionComplete();
                } else {
                    loadCurrentCard();
                }
            } else {
                alert('Review failed: ' + result.error);
            }
        }

        function updateStatsUI() {
            const stats = FlashcardStudySession.getStats();
            const progress = FlashcardStudySession.getProgress();

            document.getElementById('statReviewed').textContent = stats.cardsReviewed;
            document.getElementById('statCorrect').textContent = stats.cardsCorrect;
            document.getElementById('statAccuracy').textContent = stats.accuracy + '%';
            document.getElementById('statRemaining').textContent = progress.remaining;
        }

        function updateSessionUI() {
            const session = FlashcardStudySession.session;

            // Update streak
            if (session.streak) {
                const streakText = session.streak.current === 1 ? '1 day streak' : `${session.streak.current} days streak`;
                document.getElementById('streakCount').textContent = streakText;
            }

            // Update daily progress
            if (session.dailyProgress) {
                const { cardsToday, dailyGoal, progressPercentage } = session.dailyProgress;
                document.getElementById('dailyProgressText').textContent = `${cardsToday}/${dailyGoal} cards`;
                document.getElementById('dailyProgressBar').style.width = progressPercentage + '%';
                document.getElementById('dailyProgressBar').textContent = progressPercentage + '%';
            }
        }

        async function showSessionComplete() {
            const summary = await FlashcardStudySession.endSession();

            flashcardContainer.style.display = 'none';
            sessionComplete.style.display = 'block';

            if (summary.success) {
                const stats = summary.summary;
                document.getElementById('finalReviewed').textContent = stats.cardsReviewed || 0;
                document.getElementById('finalAccuracy').textContent = (stats.accuracy || 0) + '%';
                document.getElementById('finalTime').textContent = Math.round((stats.timeSpent || 0) / 60) + 'm';

                // Show confetti
                if (typeof confetti === 'function') {
                    confetti({
                        particleCount: 200,
                        spread: 100,
                        origin: { y: 0.6 }
                    });
                }
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if in input field
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
                    return;
                }

                switch(e.key.toLowerCase()) {
                    case ' ':  // Space - flip card
                        e.preventDefault();
                        flipCard();
                        break;
                    case '1':  // Rate: Again
                        e.preventDefault();
                        if (isFlipped) rateCard(0);
                        break;
                    case '2':  // Rate: Hard
                        e.preventDefault();
                        if (isFlipped) rateCard(3);
                        break;
                    case '3':  // Rate: Good
                        e.preventDefault();
                        if (isFlipped) rateCard(4);
                        break;
                    case '4':  // Rate: Easy
                        e.preventDefault();
                        if (isFlipped) rateCard(5);
                        break;
                }
            });
        }

        function setupTouchGestures() {
            let touchStartX = 0;
            let touchEndX = 0;

            flashcardInner.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            });

            flashcardInner.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > 50) {
                    if (swipeDistance > 0) {
                        // Swipe right - flip
                        flipCard();
                    } else {
                        // Swipe left - flip
                        flipCard();
                    }
                }
            }
        }

        // Click to flip
        document.getElementById('flashcard').addEventListener('click', flipCard);

        // Setup session callbacks
        FlashcardStudySession.on('goalReached', () => {
            updateSessionUI();
        });

        FlashcardStudySession.on('achievementUnlocked', (achievements) => {
            // Achievements are already shown by the session manager
            console.log('Achievements unlocked:', achievements);
        });
    </script>
</body>
</html>
