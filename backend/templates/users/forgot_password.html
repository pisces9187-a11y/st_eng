{% extends "base/_base_auth.html" %}
{% load static %}

{% block title %}Quên mật khẩu - EnglishMaster{% endblock %}
{% block meta_description %}Đặt lại mật khẩu tài khoản EnglishMaster{% endblock %}

{% block auth_content %}
<!-- Step 1: Enter Email -->
<div class="step-content" id="step1">
    <div class="auth-header">
        <div class="verification-icon pending mb-4">
            <i class="fas fa-lock"></i>
        </div>
        <h1 class="auth-title">Quên mật khẩu?</h1>
        <p class="auth-subtitle">Đừng lo! Nhập email của bạn và chúng tôi sẽ gửi hướng dẫn đặt lại mật khẩu.</p>
    </div>
    
    <!-- Alert messages -->
    <div id="alertContainer"></div>
    
    <form class="auth-form" id="emailForm">
        <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input type="email" 
                   class="form-control custom-input" 
                   id="email" 
                   name="email"
                   placeholder="Nhập email đã đăng ký"
                   required
                   autocomplete="email">
            <div class="invalid-feedback">Vui lòng nhập email hợp lệ</div>
        </div>
        
        <button type="submit" class="btn btn-primary-orange auth-submit" id="sendResetBtn">
            <span class="btn-text">Gửi yêu cầu</span>
            <span class="btn-loader d-none">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Đang gửi...
            </span>
        </button>
    </form>
    
    <div class="text-center mt-4">
        <a href="{% url 'users:login' %}" class="btn btn-link">
            <i class="fas fa-arrow-left me-2"></i>Quay lại đăng nhập
        </a>
    </div>
</div>

<!-- Step 2: Email Sent -->
<div class="step-content d-none" id="step2">
    <div class="auth-header text-center">
        <div class="verification-icon success mb-4">
            <i class="fas fa-envelope-open-text"></i>
        </div>
        <h1 class="auth-title">Kiểm tra email!</h1>
        <p class="auth-subtitle">
            Chúng tôi đã gửi hướng dẫn đặt lại mật khẩu đến<br>
            <strong id="displayEmail"></strong>
        </p>
    </div>
    
    <div class="alert alert-info custom-alert">
        <i class="fas fa-info-circle alert-icon me-2"></i>
        <div>
            <strong>Lưu ý:</strong>
            <ul class="mb-0 mt-2">
                <li>Kiểm tra cả thư mục Spam/Junk</li>
                <li>Link có hiệu lực trong 30 phút</li>
                <li>Nếu không nhận được, hãy thử lại sau vài phút</li>
            </ul>
        </div>
    </div>
    
    <div class="resend-section mt-4">
        <p class="text-muted text-center mb-3" id="resendTimer">
            Gửi lại sau <span id="countdown">60</span> giây
        </p>
        <button type="button" class="btn btn-outline-primary w-100 d-none" id="resendBtn" onclick="resendEmail()">
            <i class="fas fa-redo me-2"></i>Gửi lại email
        </button>
    </div>
    
    <div class="text-center mt-4">
        <a href="{% url 'users:login' %}" class="btn btn-link">
            <i class="fas fa-arrow-left me-2"></i>Quay lại đăng nhập
        </a>
    </div>
</div>

<!-- Step 3: Reset Password (token-based) -->
<div class="step-content d-none" id="step3">
    <div class="auth-header">
        <h1 class="auth-title">Đặt lại mật khẩu</h1>
        <p class="auth-subtitle">Nhập mật khẩu mới cho tài khoản của bạn</p>
    </div>
    
    <div id="alertContainer2"></div>
    
    <form class="auth-form" id="resetForm">
        <div class="form-group">
            <label for="newPassword" class="form-label">Mật khẩu mới</label>
            <div class="password-input-wrapper">
                <input type="password" 
                       class="form-control custom-input" 
                       id="newPassword" 
                       name="password"
                       placeholder="Tối thiểu 8 ký tự"
                       required
                       minlength="8">
                <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                    <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
            </div>
            <div class="password-strength mt-2">
                <div class="strength-bar">
                    <div class="strength-fill" id="strengthFill"></div>
                </div>
                <small class="strength-text" id="strengthText">Nhập mật khẩu</small>
            </div>
            <div class="invalid-feedback">Mật khẩu phải có ít nhất 8 ký tự</div>
        </div>
        
        <div class="form-group">
            <label for="confirmNewPassword" class="form-label">Xác nhận mật khẩu mới</label>
            <div class="password-input-wrapper">
                <input type="password" 
                       class="form-control custom-input" 
                       id="confirmNewPassword" 
                       name="confirm_password"
                       placeholder="Nhập lại mật khẩu"
                       required>
                <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
                    <i class="fas fa-eye" id="confirmNewPasswordIcon"></i>
                </button>
            </div>
            <div class="invalid-feedback">Mật khẩu không khớp</div>
        </div>
        
        <input type="hidden" id="resetToken" name="token">
        
        <button type="submit" class="btn btn-primary-orange auth-submit" id="resetBtn">
            <span class="btn-text">Đặt lại mật khẩu</span>
            <span class="btn-loader d-none">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Đang xử lý...
            </span>
        </button>
    </form>
</div>

<!-- Step 4: Success -->
<div class="step-content d-none" id="step4">
    <div class="auth-success-page">
        <div class="success-checkmark">
            <i class="fas fa-check"></i>
        </div>
        <h1 class="auth-title">Thành công!</h1>
        <p class="auth-subtitle mb-4">Mật khẩu của bạn đã được đặt lại.<br>Bây giờ bạn có thể đăng nhập với mật khẩu mới.</p>
        
        <a href="{% url 'users:login' %}" class="btn btn-primary-orange btn-lg">
            <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập ngay
        </a>
    </div>
</div>
{% endblock %}

{% block auth_footer %}
<p>Nhớ mật khẩu rồi? <a href="{% url 'users:login' %}">Đăng nhập</a></p>
{% endblock %}

{% block page_css %}
<style>
    .verification-icon.success {
        background: rgba(40, 167, 69, 0.1);
        color: var(--success);
    }
    
    .success-checkmark {
        width: 100px;
        height: 100px;
        margin: 0 auto var(--spacing-xl);
        background: var(--success);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 2.5rem;
        animation: checkmark-pop 0.4s ease;
    }
    
    @keyframes checkmark-pop {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block page_js %}
<script>
// ================================
// API Configuration
// ================================
const API_BASE_URL = '/api/v1';

// ================================
// State
// ================================
let userEmail = '';
let countdownTimer = null;
let resetToken = null;

// ================================
// Utility Functions
// ================================
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validatePassword(password) {
    const hasLower = /[a-z]/.test(password);
    const hasUpper = /[A-Z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    const isLongEnough = password.length >= 8;
    
    let score = 0;
    if (hasLower) score++;
    if (hasUpper) score++;
    if (hasNumber) score++;
    if (hasSpecial) score++;
    if (password.length >= 12) score++;
    
    let strength = 'weak';
    if (score >= 4) strength = 'strong';
    else if (score >= 3) strength = 'good';
    else if (score >= 2) strength = 'fair';
    
    return { valid: isLongEnough, strength };
}

function goToStep(step) {
    document.querySelectorAll('.step-content').forEach(el => el.classList.add('d-none'));
    document.getElementById('step' + step).classList.remove('d-none');
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + 'Icon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function showAlert(message, type = 'danger', containerId = 'alertContainer') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const alertClass = type === 'danger' ? 'alert-danger' : 
                       type === 'success' ? 'alert-success' : 'alert-info';
    const iconClass = type === 'danger' ? 'fa-times-circle' : 
                      type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
    
    container.innerHTML = `
        <div class="alert ${alertClass} custom-alert d-flex align-items-center" role="alert">
            <i class="fas ${iconClass} alert-icon me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.remove()"></button>
        </div>
    `;
    
    setTimeout(() => {
        if (container.innerHTML) container.innerHTML = '';
    }, 5000);
}

function setButtonLoading(btn, loading) {
    const btnText = btn.querySelector('.btn-text');
    const btnLoader = btn.querySelector('.btn-loader');
    btn.disabled = loading;
    btnText.classList.toggle('d-none', loading);
    btnLoader.classList.toggle('d-none', !loading);
}

function startCountdown() {
    let seconds = 60;
    const timerEl = document.getElementById('resendTimer');
    const countdownEl = document.getElementById('countdown');
    const resendBtn = document.getElementById('resendBtn');
    
    if (countdownTimer) clearInterval(countdownTimer);
    
    timerEl.classList.remove('d-none');
    resendBtn.classList.add('d-none');
    countdownEl.textContent = seconds;
    
    countdownTimer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        if (seconds <= 0) {
            clearInterval(countdownTimer);
            timerEl.classList.add('d-none');
            resendBtn.classList.remove('d-none');
        }
    }, 1000);
}

// ================================
// Initialize
// ================================
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have a reset token in URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
        resetToken = token;
        document.getElementById('resetToken').value = token;
        goToStep(3);
    }
});

// ================================
// Resend Email
// ================================
async function resendEmail() {
    if (!userEmail) return;
    
    const btn = document.getElementById('resendBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';
    
    try {
        const response = await fetch(`${API_BASE_URL}/auth/password-reset/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
        });
        
        if (response.ok) {
            showAlert('Email đặt lại mật khẩu đã được gửi lại!', 'success');
            startCountdown();
        } else {
            showAlert('Không thể gửi email. Vui lòng thử lại.', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Không thể kết nối đến server.', 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-redo me-2"></i>Gửi lại email';
    }
}

// ================================
// Step 1: Request Password Reset
// ================================
document.getElementById('emailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const btn = document.getElementById('sendResetBtn');
    
    // Validate email
    if (!email || !validateEmail(email)) {
        document.getElementById('email').classList.add('is-invalid');
        showAlert('Vui lòng nhập email hợp lệ', 'danger');
        return;
    }
    document.getElementById('email').classList.remove('is-invalid');
    
    setButtonLoading(btn, true);
    
    try {
        const response = await fetch(`${API_BASE_URL}/auth/password-reset/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        // Always show success for security (don't reveal if email exists)
        userEmail = email;
        document.getElementById('displayEmail').textContent = email;
        goToStep(2);
        startCountdown();
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Không thể kết nối đến server. Vui lòng thử lại.', 'danger');
    } finally {
        setButtonLoading(btn, false);
    }
});

// ================================
// Password Strength Checker
// ================================
const newPasswordInput = document.getElementById('newPassword');
if (newPasswordInput) {
    newPasswordInput.addEventListener('input', function(e) {
        const password = e.target.value;
        const validation = validatePassword(password);
        
        const fill = document.getElementById('strengthFill');
        const text = document.getElementById('strengthText');
        
        fill.className = 'strength-fill ' + validation.strength;
        
        const strengthTexts = {
            weak: 'Yếu - Cần cải thiện',
            fair: 'Trung bình',
            good: 'Tốt',
            strong: 'Mạnh - Rất tốt!'
        };
        
        text.textContent = password ? strengthTexts[validation.strength] : 'Nhập mật khẩu';
        
        // Also check confirm password
        const confirmInput = document.getElementById('confirmNewPassword');
        if (confirmInput && confirmInput.value) {
            if (password !== confirmInput.value) {
                confirmInput.classList.add('is-invalid');
            } else {
                confirmInput.classList.remove('is-invalid');
            }
        }
    });
}

// Confirm password validation
const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
if (confirmNewPasswordInput) {
    confirmNewPasswordInput.addEventListener('input', function(e) {
        const password = document.getElementById('newPassword').value;
        const confirm = e.target.value;
        
        if (confirm && password !== confirm) {
            this.classList.add('is-invalid');
        } else {
            this.classList.remove('is-invalid');
        }
    });
}

// ================================
// Step 3: Reset Password with Token
// ================================
const resetForm = document.getElementById('resetForm');
if (resetForm) {
    resetForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const password = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        const token = document.getElementById('resetToken').value;
        const btn = document.getElementById('resetBtn');
        
        // Validations
        let isValid = true;
        
        if (!password || password.length < 8) {
            document.getElementById('newPassword').classList.add('is-invalid');
            showAlert('Mật khẩu phải có ít nhất 8 ký tự', 'danger', 'alertContainer2');
            isValid = false;
        } else {
            document.getElementById('newPassword').classList.remove('is-invalid');
        }
        
        if (password !== confirmPassword) {
            document.getElementById('confirmNewPassword').classList.add('is-invalid');
            showAlert('Mật khẩu xác nhận không khớp', 'danger', 'alertContainer2');
            isValid = false;
        } else {
            document.getElementById('confirmNewPassword').classList.remove('is-invalid');
        }
        
        if (!token) {
            showAlert('Token không hợp lệ. Vui lòng yêu cầu đặt lại mật khẩu mới.', 'danger', 'alertContainer2');
            return;
        }
        
        if (!isValid) return;
        
        setButtonLoading(btn, true);
        
        try {
            const response = await fetch(`${API_BASE_URL}/auth/password-reset/confirm/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: token,
                    password: password,
                    password_confirm: confirmPassword
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                goToStep(4);
            } else {
                const errorMsg = data.detail || data.error || data.token?.[0] || 'Token không hợp lệ hoặc đã hết hạn';
                showAlert(errorMsg, 'danger', 'alertContainer2');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Không thể kết nối đến server. Vui lòng thử lại.', 'danger', 'alertContainer2');
        } finally {
            setButtonLoading(btn, false);
        }
    });
}

// Clean up
window.addEventListener('beforeunload', () => {
    if (countdownTimer) clearInterval(countdownTimer);
});
</script>
{% endblock %}
