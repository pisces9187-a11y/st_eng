{% extends "base/_base_public.html" %}
{% load static %}

{% block title %}Th·ª≠ th√°ch xo·∫Øn l∆∞·ª°i - EnglishMaster{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --danger-color: #E74C3C;
        --success-color: #27AE60;
        --warning-color: #F39C12;
    }
    
    .twister-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0 4rem;
        position: relative;
        overflow: hidden;
    }
    
    .twister-hero::before {
        content: 'üéÆ';
        position: absolute;
        font-size: 15rem;
        opacity: 0.1;
        right: -50px;
        top: -50px;
        transform: rotate(15deg);
    }
    
    .challenge-card {
        background: white;
        border-radius: 24px;
        padding: 3rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        margin-top: -80px;
        position: relative;
        z-index: 10;
    }
    
    .twister-text {
        font-size: 2rem;
        font-weight: 600;
        color: #183B56;
        text-align: center;
        padding: 2rem;
        background: #F9FAFC;
        border-radius: 16px;
        border-left: 4px solid var(--primary-color);
        margin: 2rem 0;
        line-height: 1.6;
    }
    
    .difficulty-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .difficulty-easy {
        background: rgba(39, 174, 96, 0.1);
        color: #27AE60;
    }
    
    .difficulty-medium {
        background: rgba(243, 156, 18, 0.1);
        color: #F39C12;
    }
    
    .difficulty-hard {
        background: rgba(231, 76, 60, 0.1);
        color: #E74C3C;
    }
    
    .record-button {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #E74C3C, #C0392B);
        color: white;
        font-size: 4rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        margin: 2rem auto;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .record-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(231, 76, 60, 0.4);
    }
    
    .record-button:active {
        transform: scale(0.95);
    }
    
    .record-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .record-button.recording {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }
        50% {
            box-shadow: 0 10px 50px rgba(231, 76, 60, 0.6);
        }
    }
    
    .timer {
        font-size: 3rem;
        font-weight: 700;
        color: var(--primary-color);
        text-align: center;
        margin: 1rem 0;
    }
    
    .timer.warning {
        color: var(--danger-color);
        animation: blink 0.5s infinite;
    }
    
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .leaderboard-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        height: 100%;
    }
    
    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .leaderboard-item:hover {
        background: #F9FAFC;
    }
    
    .leaderboard-item.top-1 {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: white;
    }
    
    .leaderboard-item.top-2 {
        background: linear-gradient(135deg, #C0C0C0, #A9A9A9);
        color: white;
    }
    
    .leaderboard-item.top-3 {
        background: linear-gradient(135deg, #CD7F32, #8B4513);
        color: white;
    }
    
    .rank-badge {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 1rem;
        background: #E0E6ED;
    }
    
    .score-display {
        font-size: 3rem;
        font-weight: 700;
        color: var(--success-color);
        text-align: center;
        margin: 2rem 0;
    }
    
    .feedback-message {
        text-align: center;
        font-size: 1.25rem;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1.5rem 0;
    }
    
    .feedback-message.excellent {
        background: rgba(39, 174, 96, 0.1);
        color: #27AE60;
    }
    
    .feedback-message.good {
        background: rgba(52, 152, 219, 0.1);
        color: #3498DB;
    }
    
    .feedback-message.average {
        background: rgba(243, 156, 18, 0.1);
        color: #F39C12;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }
    
    .stat-card {
        text-align: center;
        padding: 1.5rem;
        background: #F9FAFC;
        border-radius: 12px;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    /* Transcript display (Phase 5) */
    .transcript-display {
        font-size: 1.1rem;
        line-height: 1.8;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .word-highlight {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .word-highlight.excellent {
        background: rgba(39, 174, 96, 0.2);
        border: 2px solid #27AE60;
    }
    
    .word-highlight.good {
        background: rgba(52, 152, 219, 0.2);
        border: 2px solid #3498DB;
    }
    
    .word-highlight.fair {
        background: rgba(243, 156, 18, 0.2);
        border: 2px solid #F39C12;
    }
    
    .word-highlight.poor {
        background: rgba(231, 76, 60, 0.2);
        border: 2px solid #E74C3C;
    }
    
    .word-confidence {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-left: 0.25rem;
    }
    
    /* Phase 5.2: Phoneme recommendations */
    .phoneme-recommendation {
        padding: 1rem;
        margin: 0.75rem 0;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #f39c12;
    }
    
    .phoneme-recommendation.high-priority {
        border-left-color: #e74c3c;
    }
    
    .phoneme-recommendation.medium-priority {
        border-left-color: #f39c12;
    }
    
    .phoneme-recommendation.low-priority {
        border-left-color: #3498db;
    }
    
    .phoneme-ipa {
        font-size: 1.5rem;
        font-weight: 700;
        color: #667eea;
        font-family: 'Courier New', monospace;
    }
    
    .phoneme-tip {
        font-size: 0.95rem;
        color: #555;
        margin: 0.5rem 0;
    }
    
    .phoneme-words {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .phoneme-word-badge {
        padding: 0.25rem 0.75rem;
        background: #f8f9fa;
        border-radius: 20px;
        font-size: 0.875rem;
        color: #667eea;
        border: 1px solid #dee2e6;
    }
    
    .lesson-link {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: transform 0.2s;
    }
    
    .lesson-link:hover {
        transform: translateY(-2px);
        color: white;
    }
    
    /* ===================================================================
       PHASE 5.3: VISUAL ENHANCEMENTS STYLES
       =================================================================== */
    
    /* Waveform Container */
    .waveform-container {
        position: relative;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 2px solid #e9ecef;
    }
    
    .waveform-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .waveform-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
    }
    
    #waveform {
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .waveform-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }
    
    .waveform-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .waveform-btn:hover {
        background: #5568d3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .waveform-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .waveform-time {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #6c757d;
        padding: 0.5rem 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    /* Phoneme Markers on Waveform */
    .phoneme-marker {
        position: absolute;
        bottom: 0;
        width: 2px;
        height: 100%;
        background: rgba(231, 76, 60, 0.6);
        pointer-events: none;
        transition: opacity 0.2s;
    }
    
    .phoneme-marker::before {
        content: attr(data-phoneme);
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: #e74c3c;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-family: 'Courier New', monospace;
        white-space: nowrap;
    }
    
    .phoneme-marker.high-priority {
        background: rgba(231, 76, 60, 0.8);
    }
    
    .phoneme-marker.medium-priority {
        background: rgba(243, 156, 18, 0.8);
    }
    
    .phoneme-marker.low-priority {
        background: rgba(52, 152, 219, 0.8);
    }
    
    /* IPA Chart Component */
    .ipa-chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 2px solid #e9ecef;
    }
    
    .ipa-chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .ipa-chart {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.5rem;
    }
    
    .ipa-phoneme {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        padding: 0.5rem;
    }
    
    .ipa-phoneme:hover {
        background: #e9ecef;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .ipa-phoneme.problem {
        background: #fee;
        border-color: #e74c3c;
        animation: pulse 2s infinite;
    }
    
    .ipa-phoneme.problem:hover {
        background: #fdd;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .ipa-symbol {
        font-size: 1.5rem;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #667eea;
    }
    
    .ipa-phoneme.problem .ipa-symbol {
        color: #e74c3c;
    }
    
    .ipa-example {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 0.25rem;
        text-align: center;
    }
    
    .ipa-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #e74c3c;
        color: white;
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
    }
    
    /* Mouth Position Diagrams */
    .mouth-diagram-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border: 2px solid #e9ecef;
    }
    
    .mouth-diagram {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        display: block;
    }
    
    .diagram-description {
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 1rem;
        line-height: 1.6;
    }
    
    .articulatory-tips {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .tip-card {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .tip-card .tip-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .tip-card .tip-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .tip-card .tip-text {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* Visual Feedback Badge */
    .visual-enhancement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="twister-hero">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 fw-bold mb-3">
                üéÆ Th·ª≠ th√°ch xo·∫Øn l∆∞·ª°i
            </h1>
            <p class="lead">Luy·ªán ph√°t √¢m qua tr√≤ ch∆°i vui nh·ªôn!</p>
        </div>
    </div>
</div>

<div class="container pb-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="challenge-card">
                {% if twister %}
                <!-- Difficulty selector -->
                <div class="text-center mb-4">
                    <div class="btn-group" role="group">
                        <a href="?difficulty=easy" class="btn {% if difficulty == 'easy' %}btn-success{% else %}btn-outline-success{% endif %}">
                            D·ªÖ
                        </a>
                        <a href="?difficulty=medium" class="btn {% if difficulty == 'medium' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                            Trung b√¨nh
                        </a>
                        <a href="?difficulty=hard" class="btn {% if difficulty == 'hard' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            Kh√≥
                        </a>
                    </div>
                </div>
                
                <!-- Tongue twister text -->
                <div class="twister-text" id="twisterText">
                    {{ twister.text }}
                </div>
                
                <!-- IPA Transcription -->
                {% if twister.ipa_transcription %}
                <div class="alert alert-info text-center" style="background: #e8f4f8; border: 2px solid #bee5eb; border-radius: 12px; padding: 1rem; margin: 1rem 0;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i class="fas fa-book-open" style="color: #0c5460;"></i>
                        <strong style="color: #0c5460; font-size: 1.1rem;">Phi√™n √¢m IPA:</strong>
                    </div>
                    <div style="font-size: 1.3rem; color: #004085; font-family: 'Courier New', monospace; letter-spacing: 1px; line-height: 1.8;">
                        {{ twister.ipa_transcription }}
                    </div>
                    <small style="color: #0c5460; margin-top: 0.5rem; display: block;">
                        <i class="fas fa-lightbulb me-1"></i>L√†m quen v·ªõi c√°ch ph√°t √¢m chu·∫©n tr∆∞·ªõc khi luy·ªán t·∫≠p
                    </small>
                </div>
                {% endif %}
                
                {% if twister.meaning_vi %}
                <p class="text-center text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    {{ twister.meaning_vi }}
                </p>
                {% endif %}
                
                <!-- Audio playback with Web Speech API -->
                <div class="text-center mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <h6 style="color: white; margin-bottom: 1rem; font-weight: 600;">
                        <i class="fas fa-headphones-alt me-2"></i>üéß Nghe ph√°t √¢m m·∫´u
                    </h6>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-light" onclick="speakText('normal')" id="speakNormalBtn" style="font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">
                            <i class="fas fa-play-circle me-2" style="color: #667eea;"></i>T·ªëc ƒë·ªô b√¨nh th∆∞·ªùng
                        </button>
                        <button class="btn btn-light" onclick="speakText('slow')" id="speakSlowBtn" style="font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">
                            <i class="fas fa-turtle me-2" style="color: #f39c12;"></i>T·ªëc ƒë·ªô ch·∫≠m (0.7x)
                        </button>
                    </div>
                    <p style="color: rgba(255,255,255,0.9); margin-top: 1rem; margin-bottom: 0; font-size: 0.9rem;">
                        <i class="fas fa-info-circle me-1"></i>Nghe k·ªπ tr∆∞·ªõc khi ghi √¢m ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ t·ªët nh·∫•t!
                    </p>
                </div>
                
                <!-- Timer -->
                <div class="timer" id="timer">00:00</div>
                
                <!-- Record button -->
                <div class="text-center">
                    <button class="record-button" id="recordButton" onclick="toggleRecording()">
                        <i class="fas fa-microphone" id="micIcon"></i>
                    </button>
                    <p class="text-muted mt-3">
                        <small>Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu ghi √¢m (t·ªëi ƒëa 30 gi√¢y)</small>
                    </p>
                </div>
                
                <!-- Results section (hidden initially) -->
                <div id="resultsSection" style="display: none;">
                    <hr class="my-4">
                    
                    <!-- Audio Playback with enhanced quality -->
                    <div class="text-center mb-4">
                        <h6 class="mb-3" style="font-weight: 600; color: #495057;">
                            <i class="fas fa-volume-up me-2" style="color: #667eea;"></i>üéß Nghe l·∫°i b·∫£n ghi √¢m c·ªßa b·∫°n
                        </h6>
                        <div style="background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto;">
                            <audio id="recordedAudio" controls preload="auto" class="w-100" style="border-radius: 8px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));"></audio>
                        </div>
                        <p class="text-muted mt-2" style="font-size: 0.85rem;">
                            <i class="fas fa-info-circle me-1"></i>N·∫øu kh√¥ng nghe r√µ, h√£y tƒÉng √¢m l∆∞·ª£ng ho·∫∑c ki·ªÉm tra loa/tai nghe
                        </p>
                    </div>
                    
                    <div class="score-display" id="scoreDisplay">--</div>
                    <div class="feedback-message" id="feedbackMessage">--</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="durationDisplay">--</div>
                            <div class="stat-label">Th·ªùi gian (gi√¢y)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rankDisplay">--</div>
                            <div class="stat-label">X·∫øp h·∫°ng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="wordsDisplay">--</div>
                            <div class="stat-label">T·ª´ ph√°t hi·ªán</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="speedDisplay">--</div>
                            <div class="stat-label">T·ª´/gi√¢y</div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg me-2" onclick="tryAgain()">
                            <i class="fas fa-redo me-2"></i>Th·ª≠ l·∫°i
                        </button>
                        <button class="btn btn-outline-secondary btn-lg" onclick="nextTwister()">
                            <i class="fas fa-forward me-2"></i>C√¢u ti·∫øp theo
                        </button>
                    </div>
                    
                    <!-- Transcript with word highlights (Phase 5) -->
                    <div id="transcriptSection" style="display: none;" class="mt-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-file-alt me-2"></i>VƒÉn b·∫£n ph√°t hi·ªán ƒë∆∞·ª£c
                                </h6>
                                <div id="transcriptText" class="transcript-display"></div>
                                <div id="wordDetails" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phase 5.2: Phoneme Recommendations -->
                    <div id="phonemeSection" style="display: none;" class="mt-4">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="fas fa-lightbulb me-2"></i>G·ª£i √Ω luy·ªán t·∫≠p √¢m v·ªã
                                </h6>
                                <div id="phonemeRecommendations"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phase 5.3: Audio Waveform Visualization -->
                    <div id="waveformSection" style="display: none;" class="mt-4">
                        <div class="waveform-container">
                            <div class="waveform-header">
                                <h6 class="waveform-title">
                                    <i class="fas fa-waveform-lines me-2"></i>Bi·ªÉu ƒë·ªì s√≥ng √¢m thanh
                                    <span class="visual-enhancement-badge">Phase 5.3</span>
                                </h6>
                                <span class="badge bg-info">Click v√†o s√≥ng ƒë·ªÉ ph√°t t·∫°i v·ªã tr√≠ ƒë√≥</span>
                            </div>
                            <div id="waveform"></div>
                            <div class="waveform-controls">
                                <button id="playPauseBtn" class="waveform-btn" disabled>
                                    <i class="fas fa-play"></i>
                                    <span>Ph√°t</span>
                                </button>
                                <button id="stopBtn" class="waveform-btn" disabled>
                                    <i class="fas fa-stop"></i>
                                    <span>D·ª´ng</span>
                                </button>
                                <button id="replayBtn" class="waveform-btn" disabled>
                                    <i class="fas fa-redo"></i>
                                    <span>Ph√°t l·∫°i</span>
                                </button>
                                <div class="waveform-time">
                                    <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                                </div>
                                <button id="slowSpeedBtn" class="waveform-btn" title="Ph√°t ch·∫≠m">
                                    <i class="fas fa-turtle"></i>
                                    <span>0.75x</span>
                                </button>
                                <button id="normalSpeedBtn" class="waveform-btn" title="T·ªëc ƒë·ªô b√¨nh th∆∞·ªùng">
                                    <i class="fas fa-rabbit"></i>
                                    <span>1x</span>
                                </button>
                            </div>
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>G·ª£i √Ω:</strong> C√°c v·∫°ch ƒë·ªè/cam/xanh tr√™n bi·ªÉu ƒë·ªì ƒë√°nh d·∫•u c√°c √¢m v·ªã b·∫°n ph√°t √¢m ch∆∞a chu·∫©n. 
                                Click v√†o v·∫°ch ƒë·ªÉ nghe ph·∫ßn ƒë√≥ chi ti·∫øt h∆°n!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phase 5.3: Interactive IPA Chart -->
                    <div id="ipaChartSection" style="display: none;" class="mt-4">
                        <div class="ipa-chart-container">
                            <div class="ipa-chart-title">
                                <i class="fas fa-chart-network me-2"></i>B·∫£ng IPA t∆∞∆°ng t√°c
                                <span class="visual-enhancement-badge">Phase 5.3</span>
                            </div>
                            <p class="text-muted mb-3">
                                <i class="fas fa-hand-pointer me-2"></i>
                                Click v√†o m·ªói √¢m v·ªã ƒë·ªÉ xem h∆∞·ªõng d·∫´n ph√°t √¢m chi ti·∫øt. 
                                <strong class="text-danger">C√°c √¢m ƒë·ªè</strong> l√† √¢m b·∫°n c·∫ßn luy·ªán t·∫≠p.
                            </p>
                            <div id="ipaChart" class="ipa-chart"></div>
                        </div>
                    </div>
                    
                    <!-- Phase 5.3: Mouth Position Diagrams -->
                    <div id="mouthDiagramSection" style="display: none;" class="mt-4">
                        <div class="mouth-diagram-container">
                            <h6 class="text-center mb-3">
                                <i class="fas fa-head-side-cough me-2"></i>H∆∞·ªõng d·∫´n h√¨nh mi·ªáng
                                <span class="visual-enhancement-badge">Phase 5.3</span>
                            </h6>
                            <div id="mouthDiagramContent">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Ch∆∞a c√≥ tongue twister n√†o. Vui l√≤ng th·ª≠ l·∫°i sau!</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if leaderboard %}
        <div class="col-lg-4">
            <div class="leaderboard-card sticky-top" style="top: 80px;">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-trophy text-warning me-2"></i>
                    B·∫£ng x·∫øp h·∫°ng
                </h5>
                
                {% for attempt in leaderboard %}
                <div class="leaderboard-item {% if forloop.counter == 1 %}top-1{% elif forloop.counter == 2 %}top-2{% elif forloop.counter == 3 %}top-3{% endif %}">
                    <div class="rank-badge">
                        {% if forloop.counter <= 3 %}
                            {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% else %}ü•â{% endif %}
                        {% else %}
                            {{ forloop.counter }}
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">
                            {{ attempt.user.get_full_name|default:attempt.user.username }}
                            {% if attempt.user == request.user %}
                            <span class="badge bg-primary">B·∫°n</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ attempt.duration|floatformat:1 }}s</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">{{ attempt.score|floatformat:0 }}</div>
                        <small>ƒëi·ªÉm</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Phase 5.3: WaveSurfer.js for audio waveform visualization -->
<script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7.7.3/dist/wavesurfer.min.js"></script>

<script>
// ============================================================================
// PHASE 5.3: VISUAL ENHANCEMENTS - GLOBAL VARIABLES
// ============================================================================
let waveSurfer = null;  // WaveSurfer.js instance
let problemPhonemes = [];  // Problem phonemes for IPA chart highlighting
let currentAudioBlob = null;  // Current audio blob for waveform

// ============================================================================
// EXISTING VARIABLES
// ============================================================================
let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let startTime;
let timerInterval;
let isRecording = false;
const MAX_DURATION = 30; // seconds

// ============================================================================
// Edge-TTS API for high-quality text-to-speech (GLOBAL SCOPE)
// ============================================================================

let audioCache = {}; // Cache generated audio URLs

async function speakText(speed) {
    const text = '{{ twister.text|escapejs }}';
    
    // Disable buttons during generation
    const normalBtn = document.getElementById('speakNormalBtn');
    const slowBtn = document.getElementById('speakSlowBtn');
    if (normalBtn) {
        normalBtn.disabled = true;
        normalBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2" style="color: #667eea;"></i>ƒêang t·∫£i...';
    }
    if (slowBtn) {
        slowBtn.disabled = true;
        slowBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2" style="color: #f39c12;"></i>ƒêang t·∫£i...';
    }
    
    try {
        // Check cache first
        const cacheKey = `${text}_${speed}`;
        if (audioCache[cacheKey]) {
            playAudio(audioCache[cacheKey]);
            resetButtons();
            return;
        }
        
        // Call Edge-TTS API
        const response = await fetch('/api/v1/tts/speak/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                text: text,
                voice: 'en-US-AriaNeural', // High-quality female voice
                slow: speed === 'slow'
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.audio_url) {
            // Cache the audio URL
            audioCache[cacheKey] = data.audio_url;
            
            // Play the audio
            playAudio(data.audio_url);
        } else {
            console.error('TTS Error:', data.error);
            alert('Kh√¥ng th·ªÉ t·∫°o audio. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    } catch (error) {
        console.error('TTS Network Error:', error);
        alert('L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
    } finally {
        resetButtons();
    }
}

function playAudio(audioUrl) {
    // Create or reuse audio element
    let audio = document.getElementById('sampleAudio');
    if (!audio) {
        audio = new Audio();
        audio.id = 'sampleAudio';
    }
    
    audio.src = audioUrl;
    audio.volume = 1.0;
    audio.play().catch(err => {
        console.error('Audio playback error:', err);
        alert('Kh√¥ng th·ªÉ ph√°t audio. Vui l√≤ng th·ª≠ l·∫°i.');
    });
}

function resetButtons() {
    const normalBtn = document.getElementById('speakNormalBtn');
    const slowBtn = document.getElementById('speakSlowBtn');
    
    if (normalBtn) {
        normalBtn.disabled = false;
        normalBtn.innerHTML = '<i class="fas fa-play-circle me-2" style="color: #667eea;"></i>T·ªëc ƒë·ªô b√¨nh th∆∞·ªùng';
    }
    if (slowBtn) {
        slowBtn.disabled = false;
        slowBtn.innerHTML = '<i class="fas fa-turtle me-2" style="color: #f39c12;"></i>T·ªëc ƒë·ªô ch·∫≠m (0.7x)';
    }
}

function playExample(type) {
    const audio = document.getElementById(type === 'slow' ? 'audioSlow' : 'audioNormal');
    if (audio) audio.play();
}

// ============================================================================
// Recording Functions
// ============================================================================

function toggleRecording() {
    if (!isRecording) {
        startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        // Request high-quality audio with noise suppression
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 48000,
                channelCount: 1
            }
        });
        
        // Use best available audio format
        let options = {};
        if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            options = { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 128000 };
        } else if (MediaRecorder.isTypeSupported('audio/webm')) {
            options = { mimeType: 'audio/webm', audioBitsPerSecond: 128000 };
        } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
            options = { mimeType: 'audio/ogg;codecs=opus', audioBitsPerSecond: 128000 };
        }
        
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            // Use the actual MIME type from MediaRecorder
            const mimeType = mediaRecorder.mimeType || 'audio/webm';
            audioBlob = new Blob(audioChunks, { type: mimeType });
            
            // Create better quality audio URL with proper handling
            const audioURL = URL.createObjectURL(audioBlob);
            const audioElement = document.getElementById('recordedAudio');
            
            // Clear previous audio
            if (audioElement.src) {
                URL.revokeObjectURL(audioElement.src);
            }
            
            // Set audio source with volume boost
            audioElement.src = audioURL;
            audioElement.volume = 1.0; // Maximum volume
            audioElement.preload = 'auto';
            
            // Show the audio player with fade-in effect
            audioElement.style.display = 'block';
            audioElement.style.opacity = '0';
            setTimeout(() => {
                audioElement.style.transition = 'opacity 0.3s';
                audioElement.style.opacity = '1';
            }, 10);
            
            // Add event listeners for better user feedback
            audioElement.onloadeddata = () => {
                console.log('‚úÖ Audio loaded successfully, duration:', audioElement.duration);
            };
            
            audioElement.onerror = (e) => {
                console.error('‚ùå Audio playback error:', e);
                alert('Kh√¥ng th·ªÉ ph√°t l·∫°i audio. Vui l√≤ng th·ª≠ ghi √¢m l·∫°i.');
            };
            
            submitRecording(audioBlob);
        };
        
        mediaRecorder.start();
        isRecording = true;
        startTime = Date.now();
        
        // Update UI
        document.getElementById('recordButton').classList.add('recording');
        document.getElementById('micIcon').className = 'fas fa-stop';
        
        // Start timer
        timerInterval = setInterval(updateTimer, 100);
        
        // Auto-stop after MAX_DURATION
        setTimeout(() => {
            if (isRecording) {
                stopRecording();
            }
        }, MAX_DURATION * 1000);
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng cho ph√©p quy·ªÅn truy c·∫≠p.');
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        
        // Stop timer
        clearInterval(timerInterval);
        
        // Update UI
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordButton').disabled = true;
        document.getElementById('micIcon').className = 'fas fa-spinner fa-spin';
    }
}

function updateTimer() {
    const elapsed = (Date.now() - startTime) / 1000;
    const minutes = Math.floor(elapsed / 60);
    const seconds = Math.floor(elapsed % 60);
    const milliseconds = Math.floor((elapsed % 1) * 10);
    
    const timerElement = document.getElementById('timer');
    timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${milliseconds}`;
    
    if (elapsed > MAX_DURATION - 5) {
        timerElement.classList.add('warning');
    }
}

async function submitRecording(audioBlob) {
    const duration = (Date.now() - startTime) / 1000;
    
    const formData = new FormData();
    formData.append('twister_id', '{{ twister.id }}');
    formData.append('duration', duration);
    formData.append('audio', audioBlob, 'recording.wav');
    
    try {
        const response = await fetch('{% url "curriculum:tongue-twister-submit" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showResults(data);
        } else {
            alert('L·ªói: ' + data.error);
            resetUI();
        }
    } catch (error) {
        console.error('Error submitting recording:', error);
        alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i b√†i. Vui l√≤ng th·ª≠ l·∫°i.');
        resetUI();
    }
}

function showResults(data) {
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    
    // Update score
    document.getElementById('scoreDisplay').textContent = data.score + ' ƒëi·ªÉm';
    
    // Update feedback
    const feedbackElement = document.getElementById('feedbackMessage');
    feedbackElement.textContent = data.feedback;
    
    if (data.score >= 90) {
        feedbackElement.className = 'feedback-message excellent';
    } else if (data.score >= 70) {
        feedbackElement.className = 'feedback-message good';
    } else {
        feedbackElement.className = 'feedback-message average';
    }
    
    // Update stats
    document.getElementById('durationDisplay').textContent = data.duration.toFixed(1);
    document.getElementById('rankDisplay').textContent = '#' + data.rank;
    document.getElementById('wordsDisplay').textContent = data.words_detected + '/' + data.words_expected;
    
    // Use speed from API if available, otherwise calculate
    const speed = data.speed || (data.words_detected / data.duration);
    document.getElementById('speedDisplay').textContent = speed.toFixed(1);
    
    // Phase 5: Show transcript with word-level highlights
    if (data.transcript && data.transcript !== '[Mock mode - no transcript]') {
        const transcriptSection = document.getElementById('transcriptSection');
        const transcriptText = document.getElementById('transcriptText');
        const wordDetails = document.getElementById('wordDetails');
        
        // Display transcript with word highlights
        if (data.word_details && data.word_details.length > 0) {
            // Show individual words with confidence scores
            let wordsHTML = '';
            data.word_details.forEach(word => {
                const confidence = (word.confidence * 100).toFixed(0);
                let className = 'word-highlight ';
                
                if (confidence >= 95) {
                    className += 'excellent';
                } else if (confidence >= 85) {
                    className += 'good';
                } else if (confidence >= 70) {
                    className += 'fair';
                } else {
                    className += 'poor';
                }
                
                wordsHTML += `<span class="${className}">${word.word} <span class="word-confidence">${confidence}%</span></span> `;
            });
            transcriptText.innerHTML = wordsHTML;
            
            // Show detailed stats
            const avgConfidence = (data.word_details.reduce((sum, w) => sum + w.confidence, 0) / data.word_details.length * 100).toFixed(0);
            wordDetails.innerHTML = `
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    ƒê·ªô tin c·∫≠y trung b√¨nh: <strong>${avgConfidence}%</strong> | 
                    M√†u xanh = Xu·∫•t s·∫Øc, Xanh d∆∞∆°ng = T·ªët, V√†ng = Kh√°, ƒê·ªè = C·∫ßn c·∫£i thi·ªán
                </small>
            `;
        } else {
            // Simple transcript without word details
            transcriptText.innerHTML = `<p class="mb-0"><strong>"${data.transcript}"</strong></p>`;
            wordDetails.innerHTML = '';
        }
        
        transcriptSection.style.display = 'block';
    } else if (data.transcript === '[Mock mode - no transcript]') {
        // Mock mode indicator
        const transcriptSection = document.getElementById('transcriptSection');
        const transcriptText = document.getElementById('transcriptText');
        transcriptText.innerHTML = `
            <p class="mb-0 text-muted text-center">
                <i class="fas fa-flask me-2"></i>
                Ch·∫ø ƒë·ªô mock - B·∫≠t STT ƒë·ªÉ xem transcript th·ª±c
            </p>
        `;
        transcriptSection.style.display = 'block';
    }
    
    // Phase 5.2: Show phoneme recommendations
    if (data.phoneme_recommendations && data.phoneme_recommendations.length > 0) {
        displayPhonemeRecommendations(data.phoneme_recommendations);
    } else {
        document.getElementById('phonemeSection').style.display = 'none';
    }
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

/**
 * Phase 5.2: Display phoneme-level recommendations for Vietnamese learners
 * @param {Array} recommendations - List of problem phonemes with tips and affected words
 */
function displayPhonemeRecommendations(recommendations) {
    const phonemeSection = document.getElementById('phonemeSection');
    const phonemeContainer = document.getElementById('phonemeRecommendations');
    
    if (!recommendations || recommendations.length === 0) {
        phonemeSection.style.display = 'none';
        return;
    }
    
    // Generate HTML for each phoneme recommendation
    let recommendationsHTML = '';
    
    recommendations.forEach((rec, index) => {
        const priorityClass = rec.priority || 'medium';
        const ipaSymbol = rec.ipa_symbol || rec.phoneme;
        const affectedWords = rec.affected_words || [];
        const tip = rec.tip || 'H√£y luy·ªán t·∫≠p √¢m n√†y nhi·ªÅu h∆°n.';
        const vietnameseNote = rec.vietnamese_note || '';
        const frequency = rec.frequency || affectedWords.length;
        
        // Priority badge
        let priorityBadge = '';
        let priorityText = '';
        if (priorityClass === 'high') {
            priorityBadge = '<span class="badge bg-danger">∆Øu ti√™n cao</span>';
            priorityText = 'C·∫ßn t·∫≠p trung luy·ªán t·∫≠p';
        } else if (priorityClass === 'medium') {
            priorityBadge = '<span class="badge bg-warning">∆Øu ti√™n trung b√¨nh</span>';
            priorityText = 'N√™n ch√∫ √Ω c·∫£i thi·ªán';
        } else {
            priorityBadge = '<span class="badge bg-info">Luy·ªán th√™m</span>';
            priorityText = 'C√≥ th·ªÉ luy·ªán th√™m';
        }
        
        // Affected words badges
        let wordsHTML = '';
        if (affectedWords.length > 0) {
            wordsHTML = '<div class="phoneme-words mt-2">';
            affectedWords.forEach(word => {
                wordsHTML += `<span class="phoneme-word-badge">${word}</span>`;
            });
            wordsHTML += '</div>';
        }
        
        // Lesson link if available
        let lessonLink = '';
        if (rec.lesson && rec.lesson.id) {
            lessonLink = `
                <a href="/curriculum/lesson/${rec.lesson.id}/" class="lesson-link mt-3 d-inline-block">
                    <i class="fas fa-book-open me-2"></i>
                    ƒê·∫øn b√†i h·ªçc: ${rec.lesson.title}
                </a>
            `;
        }
        
        recommendationsHTML += `
            <div class="phoneme-recommendation ${priorityClass}-priority" data-index="${index}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="phoneme-ipa">/${ipaSymbol}/</span>
                        ${priorityBadge}
                    </div>
                    <span class="badge bg-secondary">${frequency} l·∫ßn</span>
                </div>
                
                <p class="phoneme-tip mb-1">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    <strong>${priorityText}:</strong> ${tip}
                </p>
                
                ${vietnameseNote ? `
                    <p class="mb-2" style="font-size: 0.9rem; color: #666; font-style: italic;">
                        <i class="fas fa-flag me-2"></i>
                        ${vietnameseNote}
                    </p>
                ` : ''}
                
                ${wordsHTML}
                ${lessonLink}
            </div>
        `;
    });
    
    phonemeContainer.innerHTML = recommendationsHTML;
    phonemeSection.style.display = 'block';
}

function resetUI() {
    document.getElementById('recordButton').disabled = false;
    document.getElementById('micIcon').className = 'fas fa-microphone';
    document.getElementById('timer').textContent = '00:00';
    document.getElementById('timer').classList.remove('warning');
}

function tryAgain() {
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('transcriptSection').style.display = 'none';
    document.getElementById('phonemeSection').style.display = 'none';  // Phase 5.2: Hide phoneme recommendations
    resetUI();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextTwister() {
    window.location.href = '?difficulty={{ difficulty }}';
}

// ============================================================================
// PHASE 5.3: WAVEFORM VISUALIZATION FUNCTIONS
// ============================================================================

/**
 * Initialize WaveSurfer.js with the recorded audio
 * @param {Blob} audioBlob - The recorded audio blob
 * @param {Array} phonemeData - Problem phonemes with timestamps
 */
function initializeWaveform(audioBlob, phonemeData = []) {
    const waveformSection = document.getElementById('waveformSection');
    const waveformContainer = document.getElementById('waveform');
    
    if (!audioBlob) {
        waveformSection.style.display = 'none';
        return;
    }
    
    // Check if WaveSurfer is loaded
    if (typeof WaveSurfer === 'undefined') {
        console.warn('WaveSurfer.js not loaded yet, waveform visualization disabled');
        waveformSection.style.display = 'none';
        return;
    }
    
    // Store audio blob globally
    currentAudioBlob = audioBlob;
    
    // Destroy existing instance
    if (waveSurfer) {
        waveSurfer.destroy();
    }
    
    // Create new WaveSurfer instance
    waveSurfer = WaveSurfer.create({
        container: waveformContainer,
        waveColor: '#667eea',
        progressColor: '#764ba2',
        cursorColor: '#e74c3c',
        barWidth: 3,
        barRadius: 3,
        cursorWidth: 2,
        height: 100,
        barGap: 2,
        responsive: true,
        normalize: true,
        interact: true,  // Allow clicking on waveform
    });
    
    // Load audio from blob
    const audioUrl = URL.createObjectURL(audioBlob);
    waveSurfer.load(audioUrl);
    
    // Event listeners
    waveSurfer.on('ready', function() {
        // Enable controls
        document.getElementById('playPauseBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('replayBtn').disabled = false;
        document.getElementById('slowSpeedBtn').disabled = false;
        document.getElementById('normalSpeedBtn').disabled = false;
        
        // Update total time
        const duration = waveSurfer.getDuration();
        document.getElementById('totalTime').textContent = formatTime(duration);
        
        // Add phoneme markers if available
        if (phonemeData && phonemeData.length > 0) {
            addPhonemeMarkers(phonemeData);
        }
    });
    
    waveSurfer.on('audioprocess', function() {
        const currentTime = waveSurfer.getCurrentTime();
        document.getElementById('currentTime').textContent = formatTime(currentTime);
    });
    
    waveSurfer.on('play', function() {
        const playBtn = document.getElementById('playPauseBtn');
        playBtn.innerHTML = '<i class="fas fa-pause"></i><span>T·∫°m d·ª´ng</span>';
    });
    
    waveSurfer.on('pause', function() {
        const playBtn = document.getElementById('playPauseBtn');
        playBtn.innerHTML = '<i class="fas fa-play"></i><span>Ph√°t</span>';
    });
    
    // Show waveform section
    waveformSection.style.display = 'block';
}

/**
 * Format time in MM:SS format
 */
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

/**
 * Add phoneme markers to waveform
 */
function addPhonemeMarkers(phonemeData) {
    if (!waveSurfer) return;
    
    const duration = waveSurfer.getDuration();
    const container = document.getElementById('waveform');
    
    // Clear existing markers
    container.querySelectorAll('.phoneme-marker').forEach(marker => marker.remove());
    
    phonemeData.forEach(phoneme => {
        if (!phoneme.timestamp) return;
        
        const position = (phoneme.timestamp / duration) * 100;
        const marker = document.createElement('div');
        marker.className = `phoneme-marker ${phoneme.priority}-priority`;
        marker.style.left = `${position}%`;
        marker.setAttribute('data-phoneme', `/${phoneme.phoneme}/`);
        marker.setAttribute('title', `${phoneme.word} - /${phoneme.phoneme}/`);
        
        container.style.position = 'relative';
        container.appendChild(marker);
    });
}

// Waveform control functions
document.addEventListener('DOMContentLoaded', function() {
    // Play/Pause button
    const playPauseBtn = document.getElementById('playPauseBtn');
    if (playPauseBtn) {
        playPauseBtn.addEventListener('click', function() {
            if (waveSurfer) {
                waveSurfer.playPause();
            }
        });
    }
    
    // Stop button
    const stopBtn = document.getElementById('stopBtn');
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            if (waveSurfer) {
                waveSurfer.stop();
            }
        });
    }
    
    // Replay button
    const replayBtn = document.getElementById('replayBtn');
    if (replayBtn) {
        replayBtn.addEventListener('click', function() {
            if (waveSurfer) {
                waveSurfer.seekTo(0);
                waveSurfer.play();
            }
        });
    }
    
    // Slow speed button
    const slowSpeedBtn = document.getElementById('slowSpeedBtn');
    if (slowSpeedBtn) {
        slowSpeedBtn.addEventListener('click', function() {
            if (waveSurfer) {
                waveSurfer.setPlaybackRate(0.75);
                this.classList.add('active');
                document.getElementById('normalSpeedBtn').classList.remove('active');
            }
        });
    }
    
    // Normal speed button
    const normalSpeedBtn = document.getElementById('normalSpeedBtn');
    if (normalSpeedBtn) {
        normalSpeedBtn.addEventListener('click', function() {
            if (waveSurfer) {
                waveSurfer.setPlaybackRate(1.0);
                this.classList.add('active');
                document.getElementById('slowSpeedBtn').classList.remove('active');
            }
        });
    }
});

// ============================================================================
// PHASE 5.3: INTERACTIVE IPA CHART FUNCTIONS
// ============================================================================

/**
 * IPA Phoneme data structure
 */
const IPA_PHONEMES = {
    consonants: [
        { ipa: 'p', example: 'pen', category: 'plosive' },
        { ipa: 'b', example: 'big', category: 'plosive' },
        { ipa: 't', example: 'tea', category: 'plosive' },
        { ipa: 'd', example: 'dog', category: 'plosive' },
        { ipa: 'k', example: 'cat', category: 'plosive' },
        { ipa: 'g', example: 'go', category: 'plosive' },
        { ipa: 'f', example: 'fish', category: 'fricative' },
        { ipa: 'v', example: 'very', category: 'fricative' },
        { ipa: 'Œ∏', example: 'think', category: 'fricative' },
        { ipa: '√∞', example: 'this', category: 'fricative' },
        { ipa: 's', example: 'see', category: 'fricative' },
        { ipa: 'z', example: 'zoo', category: 'fricative' },
        { ipa: ' É', example: 'ship', category: 'fricative' },
        { ipa: ' í', example: 'vision', category: 'fricative' },
        { ipa: 'h', example: 'hat', category: 'fricative' },
        { ipa: 't É', example: 'church', category: 'affricate' },
        { ipa: 'd í', example: 'judge', category: 'affricate' },
        { ipa: 'm', example: 'man', category: 'nasal' },
        { ipa: 'n', example: 'no', category: 'nasal' },
        { ipa: '≈ã', example: 'sing', category: 'nasal' },
        { ipa: 'l', example: 'leg', category: 'lateral' },
        { ipa: 'r', example: 'red', category: 'approximant' },
        { ipa: 'j', example: 'yes', category: 'approximant' },
        { ipa: 'w', example: 'wet', category: 'approximant' },
    ],
    vowels: [
        { ipa: 'iÀê', example: 'see', category: 'long' },
        { ipa: '…™', example: 'sit', category: 'short' },
        { ipa: 'e', example: 'bed', category: 'short' },
        { ipa: '√¶', example: 'cat', category: 'short' },
        { ipa: '…ëÀê', example: 'car', category: 'long' },
        { ipa: '…í', example: 'hot', category: 'short' },
        { ipa: '…îÀê', example: 'saw', category: 'long' },
        { ipa: ' ä', example: 'book', category: 'short' },
        { ipa: 'uÀê', example: 'boot', category: 'long' },
        { ipa: ' å', example: 'cup', category: 'short' },
        { ipa: '…úÀê', example: 'bird', category: 'long' },
        { ipa: '…ô', example: 'about', category: 'schwa' },
    ]
};

/**
 * Initialize interactive IPA chart
 * @param {Array} problemPhonemesList - List of problem phonemes to highlight
 */
function initializeIPAChart(problemPhonemesList = []) {
    const chartSection = document.getElementById('ipaChartSection');
    const chartContainer = document.getElementById('ipaChart');
    
    // Store problem phonemes globally
    problemPhonemes = problemPhonemesList;
    
    // Clear existing chart
    chartContainer.innerHTML = '';
    
    // Combine all phonemes
    const allPhonemes = [...IPA_PHONEMES.consonants, ...IPA_PHONEMES.vowels];
    
    // Create phoneme cards
    allPhonemes.forEach(phoneme => {
        const isProblem = problemPhonemes.some(p => p.phoneme === phoneme.ipa || p.ipa_symbol === phoneme.ipa);
        const problemData = problemPhonemes.find(p => p.phoneme === phoneme.ipa || p.ipa_symbol === phoneme.ipa);
        
        const card = document.createElement('div');
        card.className = `ipa-phoneme ${isProblem ? 'problem' : ''}`;
        card.setAttribute('data-phoneme', phoneme.ipa);
        card.setAttribute('data-example', phoneme.example);
        card.setAttribute('data-category', phoneme.category);
        
        // Add badge if problem
        if (isProblem && problemData) {
            const badge = document.createElement('div');
            badge.className = 'ipa-badge';
            badge.textContent = problemData.frequency || '!';
            card.appendChild(badge);
        }
        
        const symbol = document.createElement('div');
        symbol.className = 'ipa-symbol';
        symbol.textContent = `/${phoneme.ipa}/`;
        
        const example = document.createElement('div');
        example.className = 'ipa-example';
        example.textContent = phoneme.example;
        
        card.appendChild(symbol);
        card.appendChild(example);
        
        // Click event to show details
        card.addEventListener('click', function() {
            showPhonemeDetails(phoneme, isProblem, problemData);
        });
        
        chartContainer.appendChild(card);
    });
    
    // Show chart section if there are problem phonemes
    if (problemPhonemesList.length > 0) {
        chartSection.style.display = 'block';
    }
}

/**
 * Show phoneme details in modal or tooltip
 */
function showPhonemeDetails(phoneme, isProblem, problemData) {
    // You can implement a modal or tooltip here
    let message = `Phoneme: /${phoneme.ipa}/\n`;
    message += `Example: "${phoneme.example}"\n`;
    message += `Category: ${phoneme.category}\n`;
    
    if (isProblem && problemData) {
        message += `\n‚ö†Ô∏è Problem detected!\n`;
        message += `Frequency: ${problemData.frequency} times\n`;
        message += `Affected words: ${problemData.affected_words.join(', ')}\n`;
        message += `\nTip: ${problemData.tip}`;
    }
    
    alert(message);  // Simple implementation - can be replaced with modal
}

// ============================================================================
// PHASE 5.3: MOUTH POSITION DIAGRAMS
// ============================================================================

/**
 * Mouth position data for common phonemes
 */
const MOUTH_DIAGRAMS = {
    'Œ∏': {
        title: 'TH Sound (/Œ∏/) - Voiceless Dental Fricative',
        svg: '<svg viewBox="0 0 200 200" class="mouth-diagram"><circle cx="100" cy="100" r="80" fill="#ffe0e0" stroke="#e74c3c" stroke-width="3"/><rect x="90" y="60" width="20" height="30" fill="#fff" stroke="#333"/><path d="M 60 120 Q 100 140 140 120" stroke="#e74c3c" stroke-width="4" fill="none"/><text x="100" y="190" text-anchor="middle" font-size="14" fill="#666">L∆∞·ª°i gi·ªØa rƒÉng</text></svg>',
        tips: [
            { icon: 'üëÖ', title: 'V·ªã tr√≠ l∆∞·ª°i', text: 'ƒê·∫∑t l∆∞·ª°i gi·ªØa rƒÉng tr√™n v√† d∆∞·ªõi' },
            { icon: 'üí®', title: 'Lu·ªìng kh√≠', text: 'Th·ªïi kh√≠ nh·∫π qua khe h·∫πp' },
            { icon: 'üîá', title: 'Thanh qu·∫£n', text: 'Kh√¥ng rung thanh qu·∫£n' }
        ]
    },
    '√∞': {
        title: 'TH Sound (/√∞/) - Voiced Dental Fricative',
        svg: '<svg viewBox="0 0 200 200" class="mouth-diagram"><circle cx="100" cy="100" r="80" fill="#e0ffe0" stroke="#27ae60" stroke-width="3"/><rect x="90" y="60" width="20" height="30" fill="#fff" stroke="#333"/><path d="M 60 120 Q 100 140 140 120" stroke="#27ae60" stroke-width="4" fill="none"/><text x="100" y="190" text-anchor="middle" font-size="14" fill="#666">L∆∞·ª°i gi·ªØa rƒÉng + rung</text></svg>',
        tips: [
            { icon: 'üëÖ', title: 'V·ªã tr√≠ l∆∞·ª°i', text: 'Gi·ªëng /Œ∏/ nh∆∞ng c√≥ rung thanh qu·∫£n' },
            { icon: 'üí®', title: 'Lu·ªìng kh√≠', text: 'Th·ªïi kh√≠ v·ª´a ph·∫£i' },
            { icon: 'üîä', title: 'Thanh qu·∫£n', text: 'Rung thanh qu·∫£n khi ph√°t √¢m' }
        ]
    },
    ' É': {
        title: 'SH Sound (/ É/) - Voiceless Postalveolar Fricative',
        svg: '<svg viewBox="0 0 200 200" class="mouth-diagram"><circle cx="100" cy="100" r="80" fill="#e0e0ff" stroke="#667eea" stroke-width="3"/><ellipse cx="80" cy="100" rx="15" ry="20" fill="#ffe0e0"/><path d="M 70 120 Q 100 130 130 120" stroke="#667eea" stroke-width="4" fill="none"/><text x="100" y="190" text-anchor="middle" font-size="14" fill="#666">M√¥i tr√≤n, l∆∞·ª°i g·∫ßn v√≤m</text></svg>',
        tips: [
            { icon: 'üíã', title: 'H√¨nh m√¥i', text: 'L√†m tr√≤n m√¥i ra ph√≠a tr∆∞·ªõc' },
            { icon: 'üëÖ', title: 'V·ªã tr√≠ l∆∞·ª°i', text: 'L∆∞·ª°i g·∫ßn v√≤m mi·ªáng nh∆∞ng kh√¥ng ch·∫°m' },
            { icon: 'üí®', title: 'Lu·ªìng kh√≠', text: 'Th·ªïi kh√≠ t·∫°o √¢m "sh"' }
        ]
    },
    'r': {
        title: 'R Sound (/r/) - Alveolar Approximant',
        svg: '<svg viewBox="0 0 200 200" class="mouth-diagram"><circle cx="100" cy="100" r="80" fill="#fff0e0" stroke="#f39c12" stroke-width="3"/><path d="M 100 80 Q 110 90 100 100" stroke="#f39c12" stroke-width="4" fill="none"/><text x="100" y="190" text-anchor="middle" font-size="14" fill="#666">Cu·ªôn l∆∞·ª°i l√™n</text></svg>',
        tips: [
            { icon: 'üëÖ', title: 'V·ªã tr√≠ l∆∞·ª°i', text: 'Cu·ªôn l∆∞·ª°i l√™n, kh√¥ng ch·∫°m v√≤m mi·ªáng' },
            { icon: 'üîä', title: 'Thanh qu·∫£n', text: 'C√≥ rung thanh qu·∫£n' },
            { icon: '‚ö†Ô∏è', title: 'L∆∞u √Ω', text: 'Kh√°c v·ªõi "r" ti·∫øng Vi·ªát' }
        ]
    },
    'l': {
        title: 'L Sound (/l/) - Alveolar Lateral Approximant',
        svg: '<svg viewBox="0 0 200 200" class="mouth-diagram"><circle cx="100" cy="100" r="80" fill="#e0f0ff" stroke="#3498db" stroke-width="3"/><rect x="95" y="60" width="10" height="40" fill="#f39c12"/><text x="100" y="190" text-anchor="middle" font-size="14" fill="#666">L∆∞·ª°i ch·∫°m v√≤m tr∆∞·ªõc</text></svg>',
        tips: [
            { icon: 'üëÖ', title: 'V·ªã tr√≠ l∆∞·ª°i', text: 'Ch·∫°m l∆∞·ª°i v√†o v√≤m mi·ªáng sau rƒÉng tr√™n' },
            { icon: 'üí®', title: 'Lu·ªìng kh√≠', text: 'Kh√¥ng kh√≠ ch·∫£y qua hai b√™n l∆∞·ª°i' },
            { icon: '‚ö†Ô∏è', title: 'L∆∞u √Ω', text: 'L∆∞·ª°i cao h∆°n "l" ti·∫øng Vi·ªát' }
        ]
    }
};

/**
 * Show mouth diagram for a phoneme
 * @param {string} phoneme - IPA symbol
 */
function showMouthDiagram(phoneme) {
    const section = document.getElementById('mouthDiagramSection');
    const content = document.getElementById('mouthDiagramContent');
    
    const diagramData = MOUTH_DIAGRAMS[phoneme];
    
    if (!diagramData) {
        section.style.display = 'none';
        return;
    }
    
    // Build HTML
    let html = `
        <h6 class="text-center mb-3">${diagramData.title}</h6>
        <div class="text-center mb-3">
            ${diagramData.svg}
        </div>
        <div class="articulatory-tips">
    `;
    
    diagramData.tips.forEach(tip => {
        html += `
            <div class="tip-card">
                <div class="tip-icon">${tip.icon}</div>
                <div class="tip-title">${tip.title}</div>
                <div class="tip-text">${tip.text}</div>
            </div>
        `;
    });
    
    html += '</div>';
    
    content.innerHTML = html;
    section.style.display = 'block';
}

/**
 * Show mouth diagrams for top problem phonemes
 * @param {Array} recommendations - Phoneme recommendations from Phase 5.2
 */
function showTopProblemDiagrams(recommendations) {
    if (!recommendations || recommendations.length === 0) {
        return;
    }
    
    // Show diagram for the highest priority phoneme
    const topProblem = recommendations[0];
    if (topProblem && topProblem.phoneme) {
        showMouthDiagram(topProblem.phoneme);
    }
}

// ============================================================================
// PHASE 5.3: INTEGRATION WITH PHASE 5.2
// ============================================================================

// Modify showResults to include Phase 5.3 visualizations
const originalShowResults = window.showResults;
window.showResults = function(data) {
    // Call original Phase 5.1 & 5.2 logic
    if (originalShowResults) {
        originalShowResults(data);
    }
    
    // Phase 5.3: Initialize waveform if audio is available
    if (audioBlob) {
        // Prepare phoneme data with estimated timestamps
        const phonemeData = [];
        if (data.phoneme_recommendations) {
            data.phoneme_recommendations.forEach((rec, index) => {
                // Estimate timestamp based on word position
                // In production, use actual word timestamps from STT API
                const estimatedTime = (index + 1) * (data.duration / data.phoneme_recommendations.length);
                rec.affected_words.forEach(word => {
                    phonemeData.push({
                        phoneme: rec.phoneme,
                        word: word,
                        timestamp: estimatedTime,
                        priority: rec.priority
                    });
                });
            });
        }
        
        initializeWaveform(audioBlob, phonemeData);
    }
    
    // Phase 5.3: Initialize IPA chart with problem phonemes
    if (data.phoneme_recommendations) {
        initializeIPAChart(data.phoneme_recommendations);
        
        // Show mouth diagram for top problem
        showTopProblemDiagrams(data.phoneme_recommendations);
    }
};

</script>
{% endblock %}
