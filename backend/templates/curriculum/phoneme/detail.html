<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - English Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #3498db;
            --color-success: #27ae60;
            --color-warning: #f39c12;
            --color-error: #e74c3c;
            --color-text: #2c3e50;
            --color-bg: #f8f9fa;
        }

        body {
            background: var(--color-bg);
            color: var(--color-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .phoneme-detail {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Mouth Position Visualizer */
        .mouth-visualizer {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mouth-diagram-container {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .mouth-diagram {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .mouth-diagram svg {
            width: 100%;
            height: 100%;
        }

        .position-controls {
            margin: 2rem 0;
        }

        .position-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #e74c3c, #f39c12, #27ae60);
            outline: none;
            -webkit-appearance: none;
        }

        .position-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .position-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .position-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #7f8c8d;
        }

        /* Pronunciation Tips */
        .tips-section {
            background: #ecf0f1;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .tip-item {
            margin: 1rem 0;
        }

        .tip-label {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        .tip-text {
            color: var(--color-text);
        }

        /* Example Words */
        .example-words {
            margin: 2rem 0;
        }

        .word-card {
            background: white;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .word-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.1);
        }

        .word-card .play-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .word-card .play-btn:hover {
            background: #2980b9;
        }

        .word-info {
            flex: 1;
        }

        .word-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .word-ipa {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .word-meaning {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Phoneme Info Card */
        .phoneme-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .info-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
        }

        .info-label {
            font-size: 0.875rem;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Similar Phonemes Navigation */
        .similar-phonemes {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .similar-phonemes h5 {
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .phoneme-links {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .phoneme-link {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .phoneme-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: white;
        }

        /* Badge Container */
        .badge-container {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Position Descriptions */
        .position-descriptions {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            height: 100%;
        }

        .description-item {
            margin-bottom: 1.5rem;
        }

        .description-item:last-child {
            margin-bottom: 0;
        }

        .description-item h5 {
            color: var(--color-primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .description-item p {
            color: var(--color-text);
            line-height: 1.6;
            margin: 0;
        }

        /* Audio Control */
        audio {
            display: none;
        }

        .play-btn.disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mouth-diagram {
                width: 200px;
                height: 200px;
            }

            .phoneme-detail {
                padding: 1rem;
            }

            .mouth-visualizer {
                padding: 1rem;
            }

            .phoneme-link {
                font-size: 1rem;
                padding: 0.5rem 1rem;
            }

            h1.display-3 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="phoneme-detail">
        {% if not phoneme %}
        <!-- Error Message -->
        <div class="alert alert-danger">
            <h4>‚ùå Phoneme Not Found</h4>
            <p>{{ error|default:"The requested phoneme does not exist." }}</p>
            <a href="{% url 'curriculum:phoneme-chart' %}" class="btn btn-primary">‚Üê Back to Phoneme Chart</a>
        </div>
        {% else %}
        
        <!-- Header with Audio -->
        <div class="mb-4 text-center">
            <h1 class="display-3 mb-3">
                <strong>/{{ phoneme.ipa_symbol }}/</strong>
                {% if audio_url %}
                <button class="btn btn-primary btn-lg ms-3" onclick="playMainAudio()">
                    üîä Play Sound
                </button>
                <audio id="main-audio" src="{{ audio_url }}" preload="auto"></audio>
                {% endif %}
            </h1>
            <p class="lead text-muted">{{ phoneme.vietnamese_approx }}</p>
            <div class="badge-container">
                <span class="badge bg-primary">{{ phoneme.get_phoneme_type_display }}</span>
                {% if phoneme.voicing != 'n/a' %}
                <span class="badge bg-info">{{ phoneme.get_voicing_display }}</span>
                {% endif %}
                <span class="badge bg-success">Native Audio</span>
            </div>
        </div>

        <!-- Navigation: Similar Phonemes -->
        {% if similar_phonemes %}
        <div class="similar-phonemes mb-4">
            <h5>üîó Similar Phonemes in {{ phoneme.category.name }}:</h5>
            <div class="phoneme-links">
                {% for p in similar_phonemes %}
                <a href="{% url 'curriculum:phoneme-detail' p.ipa_symbol %}" class="phoneme-link">
                    /{{ p.ipa_symbol }}/
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Phoneme Info Cards -->
        <div class="phoneme-info">
            <div class="info-card">
                <div class="info-label">Type</div>
                <div class="info-value">{{ phoneme.get_phoneme_type_display }}</div>
            </div>
            <div class="info-card">
                <div class="info-label">Voicing</div>
                <div class="info-value">
                    {% if phoneme.voicing == 'voiced' %}
                    üé§ {{ phoneme.get_voicing_display }}
                    {% elif phoneme.voicing == 'voiceless' %}
                    üîá {{ phoneme.get_voicing_display }}
                    {% else %}
                    {{ phoneme.get_voicing_display }}
                    {% endif %}
                </div>
            </div>
            <div class="info-card">
                <div class="info-label">Category</div>
                <div class="info-value">{{ phoneme.category.name }}</div>
            </div>
        </div>

        <!-- Mouth Position Visualizer -->
        <div class="mouth-visualizer">
            <h2 class="mb-4">üëÑ Mouth & Tongue Position</h2>

            <div class="row">
                <div class="col-md-6">
                    <div class="mouth-diagram-container">
                        <div class="mouth-diagram">
                            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                                <!-- Head outline -->
                                <circle cx="100" cy="80" r="50" fill="none" stroke="#34495e" stroke-width="2"/>
                                
                                <!-- Nose -->
                                <line x1="100" y1="60" x2="100" y2="50" stroke="#34495e" stroke-width="2"/>
                                
                                <!-- Eyes -->
                                <circle cx="85" cy="70" r="3" fill="#34495e"/>
                                <circle cx="115" cy="70" r="3" fill="#34495e"/>
                                
                                <!-- Mouth cavity -->
                                <ellipse cx="100" cy="120" rx="30" ry="15" fill="#ffe6e6" stroke="#34495e" stroke-width="1"/>
                                
                                <!-- Lips -->
                                <path d="M 70 120 Q 100 135 130 120" fill="none" stroke="#e74c3c" stroke-width="3"/>
                                <path d="M 70 120 Q 100 105 130 120" fill="none" stroke="#e74c3c" stroke-width="2"/>
                                
                                <!-- Tongue (animated by slider) -->
                                <ellipse id="tongue" cx="100" cy="125" rx="20" ry="8" fill="#ff6b6b" opacity="0.8"/>
                                
                                <!-- Vocal cords indicator -->
                                {% if phoneme.voicing == 'voiced' %}
                                <circle id="vocal-indicator" cx="100" cy="105" r="4" fill="#27ae60">
                                    <animate attributeName="opacity" values="1;0.3;1" dur="0.5s" repeatCount="indefinite"/>
                                </circle>
                                {% endif %}
                                
                                <!-- Teeth -->
                                <rect x="70" y="115" width="60" height="3" fill="white" stroke="#95a5a6" stroke-width="0.5"/>
                                <rect x="70" y="130" width="60" height="3" fill="white" stroke="#95a5a6" stroke-width="0.5"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Position Controls -->
                    <div class="position-controls">
                        <label class="form-label"><strong>Tongue Position</strong></label>
                        <input type="range" id="tongue-slider" class="position-slider" min="0" max="100" value="50">
                        <div class="position-labels">
                            <span>Front</span>
                            <span>Central</span>
                            <span>Back</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <!-- Position Descriptions -->
                    <div class="position-descriptions">
                        <div class="description-item">
                            <h5>üó£Ô∏è Mouth Position</h5>
                            <p>{{ mouth_position_desc }}</p>
                        </div>
                        <div class="description-item">
                            <h5>üëÖ Tongue Position</h5>
                            <p>{{ tongue_position_desc }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pronunciation Tips -->
            <div class="tips-section">
                <h4 class="mb-3">üí° Pronunciation Tips</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="tip-item">
                            <div class="tip-label">How to Pronounce:</div>
                            <div class="tip-text">{{ pronunciation_tips_vi }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tip-item">
                            <div class="tip-label">Common Mistakes:</div>
                            <div class="tip-text">{{ common_mistakes_vi }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Example Words -->
        <div class="example-words">
            <h2 class="mb-4">üìö Example Words</h2>
            {% if example_words %}
                {% for word in example_words %}
                <div class="word-card">
                    {% if audio_url %}
                    <button class="play-btn" onclick="playMainAudio()" title="Play /{{ phoneme.ipa_symbol }}/ sound">
                        üîä
                    </button>
                    {% else %}
                    <div class="play-btn disabled" title="No audio available">
                        üîá
                    </div>
                    {% endif %}
                    <div class="word-info">
                        <div class="word-text">{{ word.word }}</div>
                        <div class="word-ipa">{{ word.ipa_transcription }}</div>
                        <div class="word-meaning">{{ word.meaning_vi }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="alert alert-info">
                <p class="mb-0">No example words available yet. <a href="{% url 'curriculum:phoneme-chart' %}">Browse other phonemes</a></p>
            </div>
            {% endif %}
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-5 d-flex justify-content-between">
            <a href="{% url 'curriculum:phoneme-chart' %}" class="btn btn-outline-primary btn-lg">
                ‚Üê Back to Phoneme Chart
            </a>
            <a href="{% url 'curriculum:minimal-pair-practice' %}" class="btn btn-success btn-lg">
                Practice Minimal Pairs ‚Üí
            </a>
        </div>

        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize from Django context
        const phonemeData = {
            ipa_symbol: '{{ phoneme.ipa_symbol|escapejs }}',
            vietnamese_approx: '{{ phoneme.vietnamese_approx|escapejs }}',
            phoneme_type: '{{ phoneme.get_phoneme_type_display|escapejs }}',
            voicing: '{{ phoneme.voicing|escapejs }}',
            audio_url: '{{ audio_url|escapejs }}' || null,
            pronunciation_tips_vi: `{{ pronunciation_tips_vi|escapejs }}`,
            common_mistakes_vi: `{{ common_mistakes_vi|escapejs }}`,
            example_words: {{ example_words_json|safe }}
        };

        console.log('Phoneme Data:', phonemeData);

        // Audio playback for main phoneme sound
        function playMainAudio() {
            const audioElement = document.getElementById('main-audio');
            if (audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(err => {
                    console.error('Audio playback failed:', err);
                    alert('Could not play audio. Please try again.');
                });
            } else {
                console.warn('No audio available for this phoneme');
            }
        }

        // Tongue position control - interactive mouth diagram
        const tongueSlider = document.getElementById('tongue-slider');
        const tongueElement = document.getElementById('tongue');

        if (tongueSlider && tongueElement) {
            // Set initial position based on phoneme type
            let initialPosition = 50; // Central by default
            
            // Adjust based on phoneme characteristics
            const phonemeType = phonemeData.phoneme_type.toLowerCase();
            if (phonemeType.includes('front')) {
                initialPosition = 20;
            } else if (phonemeType.includes('back')) {
                initialPosition = 80;
            } else if (phonemeType.includes('central')) {
                initialPosition = 50;
            }
            
            tongueSlider.value = initialPosition;
            updateTonguePosition(initialPosition);

            tongueSlider.addEventListener('input', (e) => {
                const position = parseInt(e.target.value);
                updateTonguePosition(position);
            });
        }

        function updateTonguePosition(position) {
            if (!tongueElement) return;
            
            // Calculate SVG coordinates
            // Position 0 (front) = cx 85, cy 125
            // Position 50 (central) = cx 100, cy 125
            // Position 100 (back) = cx 115, cy 130
            const cx = 85 + (position * 0.3);  // Front to back movement
            const cy = 125 + (position * 0.05); // Slight downward movement for back vowels
            
            tongueElement.setAttribute('cx', cx);
            tongueElement.setAttribute('cy', cy);
        }

        // Vocal cords animation
        const vocalIndicator = document.getElementById('vocal-indicator');
        if (vocalIndicator && phonemeData.voicing === 'voiced') {
            // Indicator already has CSS animation via SVG animate tag
            console.log('Voiced phoneme - vocal cords animated');
        }

        // Example words - could add individual word audio if available
        function playWordAudio(wordText) {
            console.log('Playing audio for word:', wordText);
            // For now, play the main phoneme audio
            playMainAudio();
            
            // TODO: Implement individual word audio if available
            // This would require fetching from /api/curriculum/audio-sources/?word=...
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Space bar = play audio
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                playMainAudio();
            }
            
            // Arrow keys = navigate similar phonemes
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
                const similarLinks = document.querySelectorAll('.phoneme-link');
                if (similarLinks.length > 0) {
                    // Find current phoneme in similar links and navigate
                    const firstLink = similarLinks[0];
                    if (e.code === 'ArrowRight') {
                        firstLink.click();
                    }
                }
            }
        });

        // Log for debugging
        console.log('Phoneme Detail Page Initialized');
        console.log('Audio URL:', phonemeData.audio_url);
        console.log('Example Words:', phonemeData.example_words);
    </script>
</body>
</html>
